---
title: 【记录】内网使用P4wnP1传递文件
urlname: internal-network-uses-p4wnp1-to-transfer-file
index_img: https://api.limour.top/randomImg?d=2024-10-27 07:05:01
date: 2024-10-27 15:05:01
tags: raspberrypi
---
最近实习轮转到预防了，需要在社区实习4周，而社区医生有一堆需要重复填报的数据，因此写了下面的脚本来自动化填写。而问题是社区的电脑禁用了U盘等设备的使用，因此想将这个脚本传递到其他电脑上只能手打一次。。。
于是想到的吃灰已久的`树莓派zero w`，给它刷上了 `P4wnP1 ALOA` 来模拟键盘输入，这样就不用手打了。
{% fold info @点开查看社区填报自动化脚本 %}
![](https://img.limour.top/2024/10/27/671de6fd478d1.webp)
![](https://img.limour.top/2024/10/27/671de729d6936.webp)
![](https://img.limour.top/2024/10/27/671de7533730a.webp)
{% endfold %}
## 准备工作
+ `P4wnP1_aloa` 的[镜像](https://github.com/RoganDawes/P4wnP1_aloa/releases/tag/v0.1.1-beta)，解压为 `.img`
+ [SD卡烧写工具](https://huggingface.co/datasets/Limour/archvie/blob/main/SD%E5%8D%A1%E7%83%A7%E5%86%99%E5%B7%A5%E5%85%B7.7z)

写入镜像的教程很多，就不赘述了，先格式化SD卡，然后写入`.img`文件就行
## 连接树莓派
+ 将 `树莓派zero w` 的带 `USB` 标志的口通过手机数据线连接到靶机上，`PWR`口不用管
+ 等待一个 `P4WNp1` 的 WIFI，连接它，密码是 `MaMe82-P4wnP1`，此时IP为 `172.24.0.1`
+ 或者也可以搜索一个`P4wnP1`的蓝牙，连接它，默认PIN是 `1337`，然后加入蓝牙个人区域网，此时IP为 `172.26.0.1`
+ 然后可以ssh连接对应的IP，默认用户名`root`，密码`toor`

![](https://img.limour.top/2024/10/27/671df3c9042f0.webp)
## 配置 USB
+ 访问 `http://172.24.0.1:8000/` (蓝牙就算了，太慢了打不开)
+ 此时靶机会有一个驱动错误的提示，我们需要将 `USB Gadget Settings` 中的 `CDC ECM` 和 `RNDIS` 两项关闭
+ 只保留 `Keyboard` 和 `Mouse` 两项，然后点击 `STORE` 和 `DEPLOY STORED` 后等一会，驱动错误提示就会消失了

![](https://img.limour.top/2024/10/27/671df3e21fc9b.webp)
![](https://img.limour.top/2024/10/27/671df5156410b.webp)
## 测试 HIDScript
+ 从 `USB SETTINGS` 转到 `HIDScrip`
```js
layout('us');			// 键盘布局
typingSpeed(50,100);	// 敲击按键的时候等待的间隔100毫秒加上0-150毫秒之间的随机值
 
press("GUI r");         //类似按下某个键位然后再抬起来，具体可以看官方文档，和上面的机制相识
delay(500);             //暂停时间
type("notepad\n");      //输入字符串，模拟键盘按键
delay(1500);            //暂停时间
// moveStepped(x,y);    //鼠标移动，相当于模拟正常运动
// moveTo(x,y);         //鼠标移动到设置的坐标点，x和y分别是横纵坐标
type("Hello from P4wnP1\n");

typingSpeed(10,20);
var base64 = 'SGVsbG8gZnJvbSBQNHduUDE=' // btoa('Hello from P4wnP1');
type("atob('" + base64 + "');");
```
![](https://img.limour.top/2024/10/27/671df52854a41.webp)
## 关闭树莓派
+ 不要直接拔电源，不然下次无法开机
+ ssh连接后输入 `shutdown -h now`
+ 等待 LED 灯闪烁熄灭，先别急，再等一会，会再次闪烁后熄灭
+ 此时可以安全拔掉数据线了

## 获取要模拟设备的信息
+ 下载 [USBDeview](https://huggingface.co/datasets/Limour/archvie/blob/main/USBDeview.rar)
+ 将靶机的键盘插到自己电脑上，获取`序列号`、`VID`、`PID`等信息，在 `P4wnP1` 中模拟

![](https://img.limour.top/2024/10/29/671fd70dec580.webp)
## 传递 client.html 
+ 靶机输入法调成美式键盘
+ `P4wnP1` 上运行 [HIDscript.js](https://github.com/Limour-dev/qrjs/blob/main/HIDscript.js)
+ 约 10 分钟后输入结束，此时将文件保存成 `client.html`
+ 靶机上用 `chrome` 打开 `client.html`
+ `client.html` 上选择要传递的文件，等待二维码开始变化

![](https://img.limour.top/2024/10/29/671fd82bcfdeb.webp)
## 接收文件
+ 宿主机配置对应的环境后运行 [server.py](https://github.com/Limour-dev/qrjs/blob/main/server.py)，默认是第二个摄像头
+ 可以用 win11 的连接手机功能，调用手机的摄像头
+ 将摄像头对准动态的二维码
+ 待搜集足够多的包后，会自动解码，将文件保存到 `qr.dl` 中，重命名恢复文件

## 喷泉码说明
在编码理论中，喷泉码（也称为无码率抹除码）是一类抹除码，这种编码能够从一组给定的源符号序列中产生一串不限长度的编码符号序列，在理想情况下，从编码符号序列中获得大小和源符号相同或稍大的任意子集，便可恢复源符号。
+ 对喷泉码感兴趣的话，分别有 [js](https://github.com/Limour-dev/qrjs/blob/main/FF.js) 实现和 [python](https://github.com/Limour-dev/qrjs/blob/main/FF.py) 实现，可互相编解码。